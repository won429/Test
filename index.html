<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Enjoy Vote - Ultimate Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas ìµœì‹  ë²„ì „ (1.4.1) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" type="text/css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Pretendard', sans-serif;
            background-color: #202020;
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
        }

        #mobile-frame {
            width: 100%; max-width: 430px; height: 100%; max-height: 100dvh;
            background: #F2F4F6; position: relative; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); display: flex; flex-direction: column;
            z-index: 10;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        .toss-card {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04); 
            transition: transform 0.1s; cursor: pointer;
        }
        .toss-card:active { transform: scale(0.97); }

        .screen {
            position: absolute; inset: 0; background: #F2F4F6;
            display: flex; flex-direction: column; overflow: hidden;
            opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 10;
        }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 20; }

        .full-modal {
            position: absolute; inset: 0; background: #F2F4F6; z-index: 100;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        .full-modal.open { transform: translateY(0); }

        .rank-1-card {
            background: linear-gradient(135deg, #FFF 0%, #FDF4FF 100%);
            border: 2px solid #D8B4FE; box-shadow: 0 8px 32px rgba(168, 85, 247, 0.15);
        }
        .bar-gradient { background: linear-gradient(90deg, #C084FC 0%, #A855F7 100%); }
        .number-counting { font-variant-numeric: tabular-nums; }
        
        #confetti-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 150;
        }

        /* ğŸ“¸ [ìˆ˜ì •] ìº¡ì²˜ ìŠ¤í…Œì´ì§€ (í™”ë©´ ë§¨ ìœ„ ë®ê°œ) */
        #capture-stage {
            position: fixed; 
            inset: 0; 
            background: #202020; /* ë°°ê²½ì„ ê°€ë ¤ì¤Œ */
            z-index: 9999; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            opacity: 0; 
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #capture-stage.active { opacity: 1; pointer-events: auto; }
        
        /* ğŸ“¸ í”„ë¦¬ë¯¸ì—„ í‹°ì¼“ ë””ìì¸ */
        .premium-cert {
            width: 375px; height: 550px; /* ëª¨ë°”ì¼ í™”ë©´ì— ë“¤ì–´ì˜¤ë„ë¡ í¬ê¸° ì¡°ì • */
            background: #111;
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            font-family: 'Pretendard', sans-serif;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .cert-bg-gradient {
            position: absolute; inset: 0;
            background: radial-gradient(circle at 100% 0%, #7C3AED 0%, #C026D3 50%, #111 100%);
            opacity: 0.8;
        }
        .cert-noise {
            position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.4;
        }
        .cert-content {
            position: relative; z-index: 10; height: 100%; 
            display: flex; flex-direction: column; justify-content: space-between; padding: 30px;
        }
        .cert-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 20px;
        }
        .cert-body {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .holo-badge {
            background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px; border-radius: 99px;
            color: #fff; font-size: 12px; font-weight: 700; letter-spacing: 1px;
            margin-bottom: 20px; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .cert-footer {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);
            border-radius: 16px; padding: 16px; border: 1px solid rgba(255,255,255,0.1);
        }

        /* íŒì—… */
        .custom-modal {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 200; display: none; flex-direction: column; 
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .custom-modal.show { display: flex; }
        .scale-up { animation: scaleUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <!-- ğŸ“¸ ìº¡ì²˜ ìŠ¤í…Œì´ì§€ (í™”ë©´ ë®ê°œ + ì¸ì¦ì„œ) -->
    <div id="capture-stage">
        <div class="absolute inset-0 flex flex-col items-center justify-center z-50 text-white">
            <i class="fa-solid fa-spinner fa-spin text-4xl mb-4"></i>
            <p class="font-bold text-lg">ì¸ì¦ì„œ ë§Œë“œëŠ” ì¤‘...</p>
        </div>
        
        <!-- ì‹¤ì œ ìº¡ì²˜ë  ìš”ì†Œ (ì¤‘ì•™ ë°°ì¹˜) -->
        <div id="cert-target" class="premium-cert scale-90">
            <div class="cert-bg-gradient"></div>
            <div class="cert-noise"></div>
            <div class="cert-content">
                <div class="cert-header">
                    <div><h2 class="text-3xl font-black text-white tracking-tighter italic">ENJOY<br>INKIGAYO</h2></div>
                    <div class="text-right"><p class="text-white/60 text-xs font-mono">OFFICIAL CERTIFICATE</p><p class="text-white/40 text-[10px] font-mono tracking-widest">PRE-VOTE</p></div>
                </div>
                <div class="cert-body">
                    <div class="holo-badge"><i class="fa-solid fa-lock text-xs mr-1"></i> Secret Ballot</div>
                    <h1 class="text-5xl font-black text-white leading-tight mb-2 drop-shadow-2xl">VOTE<br>COMPLETED</h1>
                    <p class="text-purple-200 text-base font-medium">íˆ¬í‘œ ì°¸ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</p>
                    <div class="w-12 h-1 bg-white/20 rounded-full mt-6 mb-6"></div>
                    <p class="text-white/80 text-lg font-bold">Certified by <span id="cert-user-name" class="text-white border-b border-white/50 pb-1">User</span></p>
                </div>
                <div class="cert-footer">
                    <div><p class="text-[10px] text-white/50 uppercase font-bold mb-1">Date</p><p id="cert-date" class="text-white font-mono text-lg">DATE</p></div>
                    <div class="text-right"><p class="text-[10px] text-white/50 uppercase font-bold mb-1">Time</p><p id="cert-time" class="text-white font-mono text-lg">TIME</p></div>
                </div>
            </div>
            <div class="absolute bottom-3 left-0 right-0 text-center opacity-30">
                <div class="h-4 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAiPjxyZWN0IHdpZHRoPSIyIiBoZWlnaHQ9IjEwIiB4PSIwIiBmaWxsPSIjZmZmIi8+PHJlY3Qgd2lkdGg9IjIiIGhlaWdodD0iMTAiIHg9IjQiIGZpbGw9IiNmZmYiLz48cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSIxMCIgeD0iOCIgZmlsbD0iI2ZmZiIvPjxyZWN0IHdpZHRoPSIyIiBoZWlnaHQ9IjEwIiB4PSIxNCIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==')] bg-repeat-x w-full"></div>
            </div>
        </div>
    </div>

    <div id="mobile-frame">
        <canvas id="confetti-canvas"></canvas>
        
        <!-- ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
        <div id="name-input-modal" class="custom-modal">
            <div class="bg-white w-[85%] max-w-[320px] rounded-[24px] p-6 text-center scale-up shadow-2xl">
                <h3 class="text-xl font-bold text-[#191F28] mb-2">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</h3>
                <p class="text-sm text-gray-500 mb-6">ì¸ì¦ì„œì— ì´ë¦„ì´ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
                <input type="text" id="voter-name-input" placeholder="ì˜ˆ: ê¹€ì—”ì¡°" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3.5 text-center text-lg font-bold text-[#191F28] mb-4 focus:ring-2 focus:ring-purple-500 outline-none" autocomplete="off">
                <div class="flex gap-2">
                    <button onclick="document.getElementById('name-input-modal').classList.remove('show')" class="flex-1 bg-gray-100 text-gray-500 font-bold py-3.5 rounded-xl">ì·¨ì†Œ</button>
                    <button onclick="window.confirmNameAndGenerate()" class="flex-1 bg-purple-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform">í™•ì¸</button>
                </div>
            </div>
        </div>

        <!-- ì´ë¯¸ì§€ ê²°ê³¼ íŒì—… -->
        <div id="img-preview-modal" class="custom-modal">
            <div class="w-full h-full flex flex-col items-center justify-center p-6 relative">
                <button onclick="closePreview()" class="absolute top-6 right-6 w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white text-xl z-50 hover:bg-white/30">âœ•</button>
                <div class="text-center mb-6 scale-up">
                    <h3 class="text-white font-bold text-2xl mb-2">ì¸ì¦ì„œ ë°œê¸‰ ì™„ë£Œ âœ¨</h3>
                    <p class="text-white/60 text-sm">ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ë‹¤ë©´<br><span class="text-yellow-300 font-bold">ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥</span>í•˜ì„¸ìš”!</p>
                </div>
                
                <img id="generated-cert-img" src="" class="w-[75%] h-auto rounded-xl shadow-2xl mb-8 border border-white/10 ring-4 ring-purple-500/30 scale-up">
                
                <a id="download-link" href="#" download="vote_cert.png" class="w-full max-w-[280px] bg-white text-purple-600 px-6 py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-transform flex items-center justify-center gap-2 scale-up">
                    <i class="fa-solid fa-download"></i> ì•¨ë²”ì— ì €ì¥í•˜ê¸°
                </a>
            </div>
        </div>

        <!-- ë©”ì¸ í™”ë©´ -->
        <div id="screen-home" class="screen active">
            <header class="flex-none px-5 pt-safe pb-2 flex items-center bg-white/50 backdrop-blur-md sticky top-0 z-20 h-14">
                <h1 class="text-xl font-bold text-[#191F28]">ì—”ì¡°ì´ íˆ¬í‘œ</h1>
            </header>

            <div class="flex-1 overflow-y-auto scrollbar-hide px-5 pb-20 pt-2">
                <!-- ë°°ë„ˆ -->
                <div class="fade-in-up delay-100 mb-8 w-full h-72 rounded-[28px] relative overflow-hidden cursor-pointer group shadow-lg shadow-purple-200" onclick="window.openPollDetail(0)">
                    <div class="absolute inset-0 bg-gradient-to-br from-[#F3E8FF] via-[#E9D5FF] to-[#D8B4FE]"></div>
                    <div class="absolute -right-4 -top-4 w-40 h-40 bg-white/40 rounded-full blur-2xl"></div>
                    <div class="absolute -left-4 bottom-4 w-32 h-32 bg-purple-300/30 rounded-full blur-2xl"></div>
                    <img src="program_logo.png" alt="Logo" class="absolute right-4 bottom-4 w-36 h-36 object-contain drop-shadow-xl rotate-[-5deg] filter brightness-105" onerror="this.style.display='none'; document.getElementById('fb-icon').style.display='block'">
                    <div id="fb-icon" class="hidden absolute right-6 bottom-6 text-[80px] drop-shadow-lg rotate-[-10deg] filter brightness-105">ğŸ¤</div>
                    <div class="relative z-10 h-full p-6 flex flex-col justify-between">
                        <div>
                            <span class="inline-flex items-center gap-1 bg-white/70 text-purple-700 text-[10px] font-bold px-2.5 py-1 rounded-full mb-2 backdrop-blur-sm shadow-sm"><span class="w-1.5 h-1.5 rounded-full bg-purple-600 animate-pulse"></span> VOTE NOW</span>
                            <h2 class="text-[26px] font-extrabold text-[#191F28] leading-[1.15]">ì„¤ë‚ íŠ¹ì„ <br>ì—”ì¡°ì´ ì¸ê¸°ê°€ìš”2<br><span class="text-purple-600">ì‚¬ì „íˆ¬í‘œ</span></h2>
                            <p class="text-gray-600 font-medium mt-3 text-xs opacity-80">ğŸµ ë„ˆì˜ ëª¨ë“  ìˆœê°„<br>ğŸµ í°ìˆ˜ì—¼ ê³ ë˜</p>
                        </div>
                        <div class="flex items-center gap-2"><span class="text-xs font-bold text-white bg-purple-500 px-5 py-2.5 rounded-full shadow-md">ì§€ê¸ˆ íˆ¬í‘œí•˜ê¸° â†’</span></div>
                    </div>
                </div>

                <!-- ê²°ê³¼ & ë¹„ìœ¨ -->
                <div class="fade-in-up delay-200">
                    <h3 class="text-lg font-bold text-[#191F28] mb-3 px-1">íˆ¬í‘œ ê²°ê³¼</h3>
                    <div id="result-list" class="space-y-3"></div>
                </div>
                <div class="fade-in-up delay-300 mt-8 mb-6">
                    <h3 class="text-lg font-bold text-[#191F28] mb-3 px-1">íˆ¬í‘œ ë°˜ì˜ ë¹„ìœ¨</h3>
                    <div class="bg-white/70 backdrop-blur-sm rounded-[24px] p-5 border border-white/60 shadow-sm space-y-5">
                        <div><div class="flex justify-between items-end mb-2"><span class="text-xs font-bold text-gray-500">ì•„í‹°ìŠ¤íŠ¸ ì‚¬ì „íˆ¬í‘œ</span><span class="text-sm font-bold text-blue-500">15%</span></div><div class="w-full bg-gray-100/80 rounded-full h-2.5 overflow-hidden"><div class="bg-blue-400 h-full rounded-full" style="width: 15%"></div></div></div>
                        <div><div class="flex justify-between items-end mb-2"><span class="text-xs font-bold text-gray-500">ë…¸ë˜ì œëª© ì‚¬ì „íˆ¬í‘œ</span><span class="text-sm font-bold text-green-500">15%</span></div><div class="w-full bg-gray-100/80 rounded-full h-2.5 overflow-hidden"><div class="bg-green-400 h-full rounded-full" style="width: 15%"></div></div></div>
                        <div><div class="flex justify-between items-end mb-2"><span class="text-xs font-bold text-gray-500">AI ì‹¤ë ¥í‰ê°€</span><span class="text-sm font-bold text-pink-500">30%</span></div><div class="w-full bg-gray-100/80 rounded-full h-2.5 overflow-hidden"><div class="bg-pink-400 h-full rounded-full" style="width: 30%"></div></div></div>
                        <div><div class="flex justify-between items-end mb-2"><span class="text-xs font-bold text-gray-500">ë³¸íˆ¬í‘œ (ìƒë°©ì†¡)</span><span class="text-sm font-bold text-purple-600">40%</span></div><div class="w-full bg-gray-100/80 rounded-full h-2.5 overflow-hidden"><div class="bg-purple-600 h-full rounded-full" style="width: 40%"></div></div></div>
                    </div>
                </div>
                <div class="h-8"></div>
            </div>
        </div>

        <!-- ëª¨ë‹¬ (ìƒì„¸) -->
        <div id="modal-detail" class="full-modal">
            <header class="flex-none px-5 pt-safe pb-2 flex justify-between items-center bg-white/80 backdrop-blur-md border-b border-gray-100 z-20 h-14">
                <button onclick="window.closeModal()" class="w-8 h-8 rounded-full hover:bg-black/5 flex items-center justify-center"><i class="fa-solid fa-chevron-left text-lg text-[#191F28]"></i></button>
                <span class="text-sm font-bold text-[#191F28]">íˆ¬í‘œ ìƒì„¸</span>
                <div class="w-8"></div>
            </header>
            <div class="flex-1 overflow-y-auto scrollbar-hide px-5 pt-6 pb-10">
                <div class="text-center mb-8">
                    <span id="poll-badge" class="inline-block px-2 py-1 bg-gray-100 text-gray-600 text-[10px] font-bold rounded mb-2">ìƒíƒœ</span>
                    <h2 id="detail-title" class="text-2xl font-bold text-[#191F28] mb-1.5 leading-tight break-keep">ì œëª©</h2>
                    <p id="detail-info" class="text-xs text-gray-500 font-medium">ì •ë³´</p>
                </div>
                <div id="detail-options" class="space-y-3 pb-8"></div>
                <div class="mt-4 pb-12">
                    <button id="btn-submit" onclick="window.submitVote()" class="w-full bg-purple-500 text-white font-bold text-lg py-4 rounded-[24px] shadow-lg active:scale-95 transition-transform disabled:bg-gray-300">íˆ¬í‘œí•˜ê¸°</button>
                    <div id="result-buttons" class="hidden space-y-3 mt-3">
                        <button onclick="window.voteAgain()" class="w-full bg-white border border-purple-200 text-purple-600 font-bold text-lg py-4 rounded-[24px] shadow-sm active:scale-95 transition-transform">í•œ ë²ˆ ë” íˆ¬í‘œí•˜ê¸° â†º</button>
                        <button onclick="window.startCertProcess()" class="w-full bg-gray-100 text-gray-600 font-bold text-base py-3.5 rounded-[24px] active:scale-95 transition-transform flex items-center justify-center gap-2">
                            <i class="fa-solid fa-camera"></i> íˆ¬í‘œ ì¸ì¦ì„œ ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ë°” -->
        <nav id="bottom-nav">
            <div class="flex items-center bg-white/90 backdrop-blur-xl shadow-[0_4px_20px_rgb(0,0,0,0.1)] border border-white/50 rounded-full p-1 gap-1">
                <div id="nav-bg" class="absolute top-1 bottom-1 bg-gray-100 rounded-full z-0 transition-all duration-300 ease-out" style="left: 4px; width: 56px;"></div>
                <button onclick="window.switchTab(0)" class="relative z-10 w-14 py-1.5 flex flex-col items-center gap-0.5 group" id="btn-tab-0"><i class="fa-solid fa-house text-lg text-[#191F28]"></i><span class="text-[9px] font-bold text-[#191F28]">í™ˆ</span></button>
                <button onclick="window.switchTab(1)" class="relative z-10 w-14 py-1.5 flex flex-col items-center gap-0.5 group" id="btn-tab-1"><i class="fa-solid fa-user text-lg text-[#B0B8C1]"></i><span class="text-[9px] font-medium text-[#B0B8C1]">ë‚´ ì •ë³´</span></button>
            </div>
        </nav>
    </div>

    <script>
        window.polls = [
            { id: 0, type: 'active', title: "ì„¤ë‚ íŠ¹ì„  ì—”ì¡°ì´ ì¸ê¸°ê°€ìš”2 ì‚¬ì „íˆ¬í‘œ ğŸ¤", author: "ì—”ì¡°ì´ ì œì‘ì§„", total: 0, options: [{ text: "ë„ˆì˜ ëª¨ë“  ìˆœê°„", count: 0 }, { text: "í°ìˆ˜ì—¼ ê³ ë˜", count: 0 }], myPick: null, hasVoted: false },
            { id: 1, type: 'result', title: "ì¸ê¸°ê°€ìš”2 ì•„í‹°ìŠ¤íŠ¸ ì‚¬ì „íˆ¬í‘œ ğŸ‘¨â€ğŸ¤", author: "ì—”ì¡°ì´ ì œì‘ì§„", total: 5, options: [{ text: "ì „ì‹œê¸°", count: 3 }, { text: "í™ë°•ì‚¬", count: 2 }], icon: "ğŸ‘¨â€ğŸ¤", color: "bg-blue-50 text-blue-500", myPick: null, hasVoted: true }
        ];
        window.currentPollId = null;
        window.selectedOptionIdx = null;

        // [í•µì‹¬] ì¸ì¦ì„œ í”„ë¡œì„¸ìŠ¤ (ìˆ˜ì •ë¨)
        window.startCertProcess = function() {
            document.getElementById('voter-name-input').value = '';
            document.getElementById('name-input-modal').classList.add('show');
            document.getElementById('voter-name-input').focus();
        };

        window.confirmNameAndGenerate = function() {
            const name = document.getElementById('voter-name-input').value.trim();
            if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
            document.getElementById('name-input-modal').classList.remove('show');
            
            // ì´ë¦„ ë° ì‹œê°„ ì„¤ì •
            document.getElementById('cert-user-name').innerText = name;
            const now = new Date();
            document.getElementById('cert-date').innerText = now.toLocaleDateString('ko-KR', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\./g, '.');
            document.getElementById('cert-time').innerText = now.toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'});

            // ìº¡ì²˜ ìŠ¤í…Œì´ì§€ í™œì„±í™” (í™”ë©´ ë®ê¸°)
            const stage = document.getElementById('capture-stage');
            stage.classList.add('active');

            // ë Œë”ë§ ëŒ€ê¸° í›„ ìº¡ì²˜
            setTimeout(() => {
                const certEl = document.getElementById('cert-target');
                html2canvas(certEl, {
                    scale: 2, // ê³ í™”ì§ˆ
                    backgroundColor: '#111',
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    document.getElementById('generated-cert-img').src = imgData;
                    document.getElementById('download-link').href = imgData;
                    
                    stage.classList.remove('active'); // ìŠ¤í…Œì´ì§€ ìˆ¨ê¹€
                    document.getElementById('img-preview-modal').classList.add('show'); // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
                    
                    // PC ìë™ ë‹¤ìš´ë¡œë“œ
                    if(!navigator.userAgent.match(/iPhone|iPad|iPod|Android/i)) {
                        document.getElementById('download-link').click();
                    }
                }).catch(err => {
                    console.error(err);
                    alert("ìƒì„± ì‹¤íŒ¨: " + err);
                    stage.classList.remove('active');
                });
            }, 800); // 0.8ì´ˆ ëŒ€ê¸° (ë Œë”ë§ ì•ˆì •í™”)
        };

        window.closePreview = function() { document.getElementById('img-preview-modal').classList.remove('show'); }

        window.fireConfetti = function() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = document.getElementById('mobile-frame').offsetWidth;
            canvas.height = document.getElementById('mobile-frame').offsetHeight;
            const particles = [];
            const colors = ['#A855F7', '#EC4899', '#3B82F6', '#F59E0B', '#10B981'];
            for(let i=0; i<150; i++) particles.push({ x: canvas.width/2, y: canvas.height*0.25, vx:(Math.random()-0.5)*20, vy:(Math.random()-0.5)*20-5, color:colors[Math.floor(Math.random()*colors.length)], size:Math.random()*6+2, life:150, gravity:0.5 });
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    if(p.life > 0) { active = true; p.x+=p.vx; p.y+=p.vy; p.vy+=p.gravity; p.life--; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); }
                });
                if(active) requestAnimationFrame(animate); else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        };

        window.onload = function() { window.renderResultList(); window.switchTab(0); };
        window.switchTab = function(index) {
            if(index === 1) { alert('ë‚´ ì •ë³´ ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.'); return; }
            document.getElementById('nav-bg').style.transform = `translateX(${index * 60}px)`;
        };

        window.renderResultList = function() {
            const list = document.getElementById('result-list'); list.innerHTML = '';
            window.polls.filter(p => p.type === 'result').forEach(p => {
                list.innerHTML += `
                <div class="toss-card p-5 flex items-center justify-between active:scale-[0.98] transition-transform" onclick="window.openPollDetail(${p.id})">
                    <div class="flex items-center gap-4 flex-1 overflow-hidden">
                        <div class="w-12 h-12 rounded-[20px] ${p.color} flex items-center justify-center text-xl shadow-sm shrink-0">${p.icon}</div>
                        <div class="overflow-hidden">
                            <h4 class="text-base font-bold text-[#191F28] leading-tight mb-0.5 truncate pr-2">${p.title}</h4>
                            <p class="text-xs text-gray-500 font-medium">${p.total}ëª… ì°¸ì—¬ Â· ì¢…ë£Œë¨</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1.5 shrink-0 pl-2">
                        <span class="text-xs font-medium text-gray-400">ê²°ê³¼ë³´ê¸°</span>
                        <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                    </div>
                </div>`;
            });
        };

        window.openPollDetail = function(id) {
            window.currentPollId = id; window.selectedOptionIdx = null;
            const p = window.polls.find(item => item.id === id);
            document.getElementById('detail-title').innerText = p.title;
            document.getElementById('detail-info').innerText = `ì‘ì„±ì: ${p.author} Â· ${p.total}ëª… ì°¸ì—¬`;
            const badge = document.getElementById('poll-badge');
            if(p.type === 'active') { badge.className = "inline-block px-2 py-1 bg-purple-100 text-purple-600 text-[10px] font-bold rounded mb-2"; badge.innerText = "ì§„í–‰ì¤‘"; } 
            else { badge.className = "inline-block px-2 py-1 bg-gray-100 text-gray-600 text-[10px] font-bold rounded mb-2"; badge.innerText = "ì¢…ë£Œë¨"; }
            window.renderDetailContent(p);
            document.getElementById('modal-detail').classList.add('open');
            if(p.hasVoted) setTimeout(window.fireConfetti, 300);
        };
        window.closeModal = function() { document.getElementById('modal-detail').classList.remove('open'); };

        window.renderDetailContent = function(p) {
            const container = document.getElementById('detail-options');
            const btnSubmit = document.getElementById('btn-submit');
            const resultButtons = document.getElementById('result-buttons');
            container.innerHTML = '';
            const showResult = p.type === 'result' || p.hasVoted;

            if(!showResult) {
                btnSubmit.classList.remove('hidden'); resultButtons.classList.add('hidden'); btnSubmit.disabled = true; btnSubmit.innerText = "íˆ¬í‘œí•˜ê¸°";
                p.options.forEach((opt, idx) => {
                    container.innerHTML += `<label class="block cursor-pointer group active:scale-[0.98] transition-all"><input type="radio" name="v_opt" class="hidden peer" onchange="window.selectOption(${idx})"><div class="p-4 rounded-[20px] bg-white border border-white/60 shadow-sm flex items-center justify-between peer-checked:border-purple-500 peer-checked:ring-1 peer-checked:ring-purple-500 peer-checked:bg-purple-50 transition-all"><span class="font-bold text-[#191F28]">${opt.text}</span><div class="w-5 h-5 rounded-full border-2 border-gray-200 peer-checked:border-purple-500 peer-checked:bg-purple-500 flex items-center justify-center"><i class="fa-solid fa-check text-white text-[10px]"></i></div></div></label>`;
                });
            } else {
                btnSubmit.classList.add('hidden');
                if(p.type === 'active') resultButtons.classList.remove('hidden'); else resultButtons.classList.add('hidden');
                const max = Math.max(...p.options.map(o => o.count));
                p.options.forEach((opt, idx) => {
                    const pct = p.total === 0 ? 0 : Math.round((opt.count / p.total) * 100);
                    const isWin = opt.count === max && max > 0;
                    const isMy = idx === p.myPick;
                    const wrapperClass = isWin ? "rank-1-card p-5 rounded-[24px] mb-4 relative overflow-hidden" : "bg-white p-4 rounded-[20px] mb-3 border border-gray-100 shadow-sm relative overflow-hidden";
                    const barClass = isWin ? "bar-gradient" : "bg-gray-300";
                    const medal = isWin ? `<span class="ml-2 text-5xl inline-block align-middle drop-shadow-md">ğŸ¥‡</span>` : '';
                    container.innerHTML += `<div class="${wrapperClass}"><div class="flex justify-between items-end mb-2 relative z-10"><div><h4 class="text-base font-bold text-[#191F28] flex items-center">${opt.text} ${medal} ${isMy ? '<span class="text-[10px] bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded font-bold ml-2 self-center">MY</span>' : ''}</h4><p class="text-xs text-gray-400 font-medium mt-0.5">${opt.count}í‘œ</p></div><div class="text-right"><span class="text-2xl font-bold text-purple-600 number-counting" data-target="${pct}">0</span><span class="text-sm font-bold text-purple-400">%</span></div></div><div class="w-full bg-gray-100 rounded-full overflow-hidden relative z-10 ${isWin?'h-3':'h-2'}"><div class="${barClass}" style="width: 0%; height: 100%; transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1); border-radius: 99px;" data-width="${pct}%"></div></div></div>`;
                });
                setTimeout(() => {
                    container.querySelectorAll('[data-width]').forEach(el => el.style.width = el.getAttribute('data-width'));
                    container.querySelectorAll('.number-counting').forEach(el => {
                        const target = +el.getAttribute('data-target'); let current = 0;
                        const update = () => { current += Math.ceil((target - current) * 0.1); el.innerText = current; if(current < target) requestAnimationFrame(update); };
                        update();
                    });
                }, 100);
            }
        };

        window.selectOption = function(idx) { window.selectedOptionIdx = idx; document.getElementById('btn-submit').disabled = false; };
        window.submitVote = function() {
            if(window.selectedOptionIdx === null) return;
            const p = window.polls.find(item => item.id === window.currentPollId);
            p.options[window.selectedOptionIdx].count++; p.total++; p.myPick = window.selectedOptionIdx; p.hasVoted = true;
            window.renderDetailContent(p); window.fireConfetti();
        };
        window.voteAgain = function() {
            const p = window.polls.find(item => item.id === window.currentPollId);
            p.hasVoted = false; p.myPick = null; window.selectedOptionIdx = null; window.renderDetailContent(p);
        };
    </script>
</body>
</html>


